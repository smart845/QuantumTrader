<!DOCTYPE html>

<html lang="ru">
<head>
<!-- Local version with CORS proxy for Binance API -->
<!-- Works without server; requests routed via https://api.allorigins.win/get?url= -->
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" name="viewport"/>
<meta content="#120a22" name="theme-color"/>
<title>ByAgent Terminal</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>
<script src="https://unpkg.com/@tonconnect/sdk@latest"></script>
<style>
/* v4.4.4: mobile/Telegram, chart, neon styles - MODIFIED FOR NEW DESIGN */
html, body { height:100%; min-height:100%; -webkit-text-size-adjust:100%; }
body {
    margin: 0;
    color: var(--text);
    background: radial-gradient(1200px 600px at 60% -12%, rgba(0, 196, 132, 0.15), transparent 55%), 
                radial-gradient(900px 520px at 5% 15%, rgba(0, 196, 132, 0.1), transparent 60%), 
                radial-gradient(800px 500px at 95% 85%, rgba(56,189,248,.1), transparent 60%),
                linear-gradient(180deg, var(--bg1), var(--bg0));
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;
}
:root{
    --bg0: #10151C;
    --bg1: #151A23;
    --bg2: #1A202A;
    --card: #1A202A;
    --muted: #A0ACB9;
    --text: #E8F0F7;
    --border: #303A4C;
    --button-bg: #202733; 
    --button-border: #3A475C;
    --button-shadow: rgba(60, 70, 90, 0.4); 
    --green:#00C484;
    --red:#FF647C;
    --blue:#38bdf8;
    --pink:#ec4899; 
    --violet:#8b5cf6;
    --header-bg: var(--bg1);
    --glass-border: rgba(160, 172, 185, 0.2);
    --glass-bg: rgba(255, 255, 255, 0.05);
}
.wrap{ max-width: 100%; margin: 0; padding: 0 0 28px; }
.card{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--border); border-radius:16px; padding:10px; box-shadow:0 10px 40px rgba(18,10,34,.45), inset 0 0 0 1px rgba(255,255,255,.05); margin-top: 10px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
.spacer{flex:1 1 auto;}
.input{ flex:1 1 240px; background:var(--bg2); border:1px solid var(--border); color:var(--text); border-radius:12px; padding:12px; outline:none; box-shadow:inset 0 0 0 1px rgba(124,58,237,.15); }
.input:focus{ box-shadow:0 0 0 2px rgba(124,58,237,.35), inset 0 0 0 1px rgba(124,58,237,.25); }
.heading{font-weight:800; margin:8px 0;}
.badge{ border:1px solid var(--border); background:linear-gradient(180deg, var(--bg1), var(--bg0)); border-radius:12px; padding:6px 10px; color:var(--muted); box-shadow:inset 0 0 0 1px rgba(124,58,237,.12); }
.mini{font-size:12px; color:var(--muted);} .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
.neon-wrap{ display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
.neon-wrap.two{ grid-template-columns: repeat(2, 1fr); }
@keyframes pulsePink { 0%,100%{ box-shadow:0 0 0 1px rgba(236,72,153,.28), 0 0 14px rgba(236,72,153,.22), inset 0 0 0 1px rgba(236,72,153,.22);} 50%{ box-shadow:0 0 0 1px rgba(139,92,246,.6), 0 0 22px rgba(139,92,246,.35), inset 0 0 0 1px rgba(139,92,246,.35);} }
.btn{ background:var(--button-bg); color:var(--text); border:1px solid var(--button-border); border-radius:14px; padding:11px 12px; cursor:pointer; user-select:none; text-align:center; box-shadow:0 0 0 1px var(--button-shadow), 0 0 12px var(--button-shadow), inset 0 0 0 1px rgba(255,255,255,.05); transition: transform .14s ease, box-shadow .22s ease, filter .22s ease; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.btn:hover{ transform: translateY(-2px); filter: brightness(1.04); }
.seg{display:inline-flex; gap:6px; padding:4px; border-radius:12px; background:var(--bg1); border:1px solid var(--border);} 
.seg button{background:transparent; color:var(--muted); border:1px solid transparent; padding:6px 10px; border-radius:10px; cursor:pointer}
.seg button.active{background:var(--button-bg); color:var(--text); border-color:var(--button-border); box-shadow:inset 0 0 0 1px rgba(255,255,255,.1);} 
/* Modal Drawer Styles */
#modalDrawer { position: absolute; top: 0; left: 0; right: 0; height: 100%; background: var(--bg0); border-radius: 14px; overflow: hidden; z-index: 5; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0, 196, 132, 0.3); }
#modalDrawer.show { transform: translateY(0); }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg1); border-bottom: 1px solid var(--border); flex-shrink: 0; }
.modal-title { font-size: 18px; font-weight: 800; color: var(--text); }
.modal-close-btn { background: var(--red); color: var(--text); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.modal-close-btn:hover { background: #ff4d6a; }
.modal-content-body { flex-grow: 1; overflow-y: auto; padding: 10px; }
/* Top Table Styles */
.top-controls { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 6px 5px 10px; }
.top-seg { display:inline-flex; gap:6px; padding:4px; border-radius:12px; background:var(--bg1); border:1px solid var(--border); }
.top-seg button{ background:transparent; color:var(--muted); border:1px solid transparent; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700; }
.top-seg button.active{ background:var(--button-bg); color:var(--text); border-color:var(--button-border); box-shadow:inset 0 0 0 1px rgba(255,255,255,.1); }
.top-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.top-table th, .top-table td { padding: 8px 5px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.05); white-space: nowrap; }
.top-table th { color: var(--muted); font-weight: 500; text-transform: uppercase; font-size: 10px; position: sticky; top: 0; background: var(--bg0); z-index: 2; }
.top-table tr:hover { background: rgba(0, 196, 132, 0.05); }
.top-symbol { cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 5px; }
.top-symbol:hover { text-decoration: underline; }
.top-value-green { color: var(--green); font-weight: 600; }
.top-value-red { color: var(--red); font-weight: 600; }
.emoji-btn{ background:none; border:none; cursor:pointer; font-size:16px; padding:0 4px; filter: saturate(.9); }
.emoji-btn.active{ 
  filter: saturate(1.8); 
  transform: scale(1.15); 
  text-shadow: 0 0 8px gold, 0 0 16px rgba(255,215,0,.6);
}
#chartWrap{ height: 300px; border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#0a1228; position:relative; margin-top:8px; }
#tvchart{height:100%;}
@media (max-width: 640px) { #chartWrap { height: calc(100vh - 150px) !important; max-height: none !important; } }
.drawer{position:absolute; inset:8px; background:rgba(16, 11, 31, .92); border:1px solid var(--border); border-radius:14px; display:none; flex-direction:column;}
.drawer.show{ display:flex; }
.drawer .head{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--border); gap:8px; backdrop-filter: blur(10px);} 
.drawer .title{font-size:16px; font-weight:800;}
.drawerBody{padding:10px; overflow:auto; height:100%; scroll-behavior:smooth;}
.n-blue{ color:var(--blue); text-shadow:0 0 10px rgba(56,189,248,.5), 0 0 20px rgba(96,165,250,.35); }
.n-green{ color:var(--green); text-shadow:0 0 10px rgba(34,197,94,.5), 0 0 20px rgba(34,197,94,.35); }
.n-red{ color:var(--red); text-shadow:0 0 10px rgba(239,68,68,.55), 0 0 20px rgba(239,68,68,.35); }
.agent-line.flash{ animation: flashLine .4s ease both; }
.agent-line{display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:700;}
.agent-line .mono{font-weight:600;}
.header-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background-color: var(--header-bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
.header-bar .menu-icon { font-size: 24px; cursor: pointer; color: var(--muted); }
.header-bar .title-text { font-weight: 600; color: var(--text); }
.header-bar .done-button { background: transparent; color: var(--blue); font-weight: 700; border: none; padding: 0; cursor: pointer; }
.main-content { padding: 0 12px; }
.info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 12px 0; }
.info-box { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 8px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; min-height: 50px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.info-box-label { font-size: 12px; color: var(--muted); font-weight: 500; margin-bottom: 4px; }
.info-box-value { font-size: 16px; font-weight: 700; color: var(--text); }
.oi-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 12px; margin-top: 10px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.oi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.oi-title { font-size: 18px; font-weight: 800; color: var(--text); }
.oi-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
.oi-row:last-child { border-bottom: none; }
.oi-label { font-size: 14px; color: var(--muted); }
.oi-value { font-size: 14px; font-weight: 600; color: var(--text); }
.oi-value.green-line { border-bottom: 2px solid var(--green); }
.oi-value.red-line { border-bottom: 2px solid var(--red); }
.search-and-buttons { padding: 12px; background: var(--bg1); }
.search-row { display: flex; margin-bottom: 12px; position: relative; }
.search-input { padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg2); color: var(--text); } .search-row > div { flex-grow: 1; }
.search-button { padding: 10px 15px; border-radius: 14px; background: var(--button-bg); color: var(--text); border: 1px solid var(--button-border); font-weight: 600; box-shadow:0 0 0 1px var(--button-shadow), 0 0 12px var(--button-shadow), inset 0 0 0 1px rgba(255,255,255,.05); } .search-button-abs { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); height: auto; border-radius: 14px; border-left: 1px solid var(--button-border); padding: 8px 12px; }
.button-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
.button-grid .btn { padding: 12px; font-size: 14px; display: flex; align-items: center; justify-content: center; }
.button-grid .btn span { margin-left: 8px; }
.top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--bg1); border-bottom: 1px solid var(--border); }
.top-bar-left, .top-bar-right { display: flex; align-items: center; gap: 15px; }
.top-bar-icon { font-size: 20px; color: var(--muted); }
.top-bar-button { background: var(--bg2); border: 1px solid var(--glass-border); border-radius: 12px; padding: 6px 10px; color: var(--text); font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.top-bar-button i { font-size: 14px; }
  </style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<style>
#entryV, #priceV {
  color: var(--blue) !important;
  text-shadow: 0 0 10px rgba(56,189,248,.5), 0 0 20px rgba(56,189,248,.35);
  font-weight: 700;
}
</style>
<style>

/* === Minimal patch: ONLY button text gradient + emojis (no layout/borders/logic changes) === */
.button-grid #btnSetups i,
.button-grid #btnSetupsAlt i,
.button-grid #btnTop i,
.button-grid #btnAlerts i,
.button-grid #btnFav i,
.button-grid #btnListings i{ display:none; } /* —Å–∫—Ä—ã—Ç—å FA-–∏–∫–æ–Ω–∫–∏, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∂–∏ */

.button-grid #btnSetups,
.button-grid #btnSetupsAlt,
.button-grid #btnTop,
.button-grid #btnAlerts,
.button-grid #btnFav,
.button-grid #btnListings{
  background-image: linear-gradient(90deg, var(--blue), var(--green), var(--red));
  -webkit-background-clip: text;
          background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 900; /* —Ç–æ–ª—å–∫–æ —É—Å–∏–ª–µ–Ω–∏–µ –±—É–∫–≤, –≤–∏–∑—É–∞–ª—å–Ω–æ –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä—ã */
}

/* –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∂–∏ –ø–µ—Ä–µ–¥ —Ç–µ–∫—Å—Ç–æ–º (—Ç—Ä–µ–π–¥–µ—Ä-—Å—Ç–∏–ª—å) */
#btnSetups::before   { content: "ü§ñ"; }
#btnSetupsAlt::before{ content: "üì°"; }
#btnTop::before      { content: "üèÜ"; }
#btnAlerts::before   { content: "üîî"; }
#btnFav::before      { content: "‚≠ê"; }
#btnListings::before { content: "üöÄ"; }

/* –ê–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞–∑–º–µ—â–∞–µ–º —ç–º–æ–¥–∂–∏ –∏–Ω–ª–∞–π–Ω–æ–º, –±–µ–∑ —Å–¥–≤–∏–≥–∞ –≤–µ—Ä—Å—Ç–∫–∏ */
#btnSetups::before,
#btnSetupsAlt::before,
#btnTop::before,
#btnAlerts::before,
#btnFav::before,
#btnListings::before{
  display: inline-block;
  margin-right: 6px;
  vertical-align: -2px;
  /* —ç–º–æ–¥–∂–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ü–≤–µ—Ç–Ω—ã–º–∏, –ø–µ—Ä–µ–ª–∏–≤ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫ –±—É–∫–≤–∞–º */
  -webkit-text-fill-color: initial;
  background: none;
}

</style>
<style>
/* === Telegram Mini App Optimization === */
.top-table td:not(:last-child) {
  border-right: 1px solid rgba(255,255,255,0.12);
}
@media (max-width: 600px) {
  .top-table td {
    border-right: 1px solid rgba(255,255,255,0.18);
    line-height: 1.5em;
    padding-top: 6px;
    padding-bottom: 6px;
  }
}
</style>
</head>
<body>
<div class="top-bar">
<div class="top-bar-left">
<i class="fas fa-bars top-bar-icon"></i>
<span class="top-bar-icon n-blue">Quantum</span></div>
<div class="top-bar-right">
<button class="top-bar-button" id="btnWallet"><i class="fas fa-wallet"></i> –ö–æ—à–µ–ª—ë–∫</button>
<button class="top-bar-button" id="btnSettings"><i class="fas fa-chart-area"></i> <span class="n-green">–°–ø—Ä–µ–¥—ã</span></button>
</div>
</div>
<div class="search-and-buttons">
<div class="search-row">
<div style="position:relative; flex-grow:1;">
<input class="search-input mono" id="sym" list="symList" placeholder="–ü–∞—Ä–∞, —Ç–∏–∫–µ—Ä –∏–ª–∏ –∑–∞–ø—Ä–æ—Å..." spellcheck="false" style="padding-right: 35px;"/>
<button class="emoji-btn" id="btnAlertFromSearch" style="position:absolute; right:8px; top:50%;
                 transform:translateY(-50%);
                 font-size:17px; color:var(--muted);">üîî</button>
</div>
<button class="emoji-btn" id="btnFavFromSearch" style="font-size:18px; margin:0 6px;">‚≠ê</button>
<button class="btn search-button" id="btnFind" style="width: 80px;">–ù–∞–π—Ç–∏</button>
</div>
<div class="button-grid">
<button class="btn" id="btnSetups"><i class="fas fa-chart-line"></i> –¢–µ–ª–µ–±–æ—Ç</button>
<button class="btn" id="btnSetupsAlt"><i class="fas fa-flask"></i> –°–µ—Ç–∞–ø—ã</button>
<button class="btn" id="btnTop"><i class="fas fa-trophy"></i> –¢–æ–ø</button>
<button class="btn" id="btnAlerts"><i class="fas fa-bell"></i> –ê–ª–µ—Ä—Ç—ã</button>
<button class="btn" id="btnFav"><i class="fas fa-star"></i> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
<button class="btn" id="btnListings"><i class="fas fa-rocket"></i> –õ–∏—Å—Ç–∏–Ω–≥–∏</button>
</div>
</div>
<div class="wrap">
<div class="info-grid">
<div class="info-box"><div class="info-box-label">–í—Ö–æ–¥</div><div class="info-box-value mono" id="entryV">‚Äî</div></div>
<div class="info-box"><div class="info-box-label">SL</div><div class="info-box-value mono" id="slV">‚Äî</div></div>
<div class="info-box"><div class="info-box-label">TP</div><div class="info-box-value mono" id="tpV">‚Äî</div></div>
<div class="info-box"><div class="info-box-label">–¶–µ–Ω–∞</div><div class="info-box-value mono" id="priceV">‚Äî</div></div>
<div class="info-box"><div class="info-box-label">RR</div><div class="info-box-value mono" id="rrV">‚Äî</div></div>
<div class="info-box"><div class="info-box-label">–°–∏–≥–Ω–∞–ª</div><div class="info-box-value mono" id="sidePill">‚Äî</div></div>
</div>
<div id="chartWrap">
<div id="tvchart"></div>
<!-- MODAL DRAWER -->
<div id="modalDrawer">
<div class="modal-header">
<span class="modal-title" id="modalTitle"></span>
<button class="modal-close-btn" id="closeModalBtn"><i class="fas fa-times"></i></button>
</div>
<div class="modal-content-body" id="modalContent"></div>
</div>
</div>
<div class="oi-card">
<div class="oi-header">
<div class="oi-title"><span class="n-blue">Open Interest ‚Äî <span id="oiSym">BTCUSDT</span></span></div>
<div class="seg" id="oiTimeSeg"><button class="active" data-time="5m">5m</button><button data-time="15m">15m</button><button data-time="1h">1h</button></div>
</div>
<div class="oi-data">
<div class="oi-row"><span class="oi-label n-green">Taker Buy (5m)</span><span class="oi-value mono green-line" id="takerBuyV">‚Äî</span></div>
<div class="oi-row"><span class="oi-label n-red">Taker Sell (5m)</span><span class="oi-value mono red-line" id="takerSellV">‚Äî</span></div>
<div class="oi-row"><span class="oi-label">Open Interest (now)</span><span class="oi-value mono" id="oiNowV">‚Äî</span></div>
<div class="oi-row"><span class="oi-label">Œî OI vs prev</span><span class="oi-value mono" id="oiDeltaV">‚Äî</span></div>
<div class="oi-row"><span class="oi-label">–í—Å–µ–≥–æ (Buy+Sell, 5m)</span><span class="oi-value mono" id="oiTotalV">‚Äî</span></div>
<div class="oi-row"><span class="oi-label">BTCUSDT ‚Ä¢ Bybit linear</span><span class="oi-value mini">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span class="mono" id="oiUpdatedV">‚Äî</span></span></div>
</div>
</div>
</div>
<!-- Templates for modals -->
<div id="modalSetups" style="display:none;"><p class="heading n-blue">–¢–µ–ª–µ–±–æ—Ç</p><p class="mini">–ú–æ–¥–∞–ª–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.</p></div>
<div id="modalSetupsAlt" style="display:none;"><p class="heading n-red">–°–µ—Ç–∞–ø—ã</p></div>
<div id="modalFavorites" style="display:none;"><p class="heading n-green">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</p></div>
<div id="modalListings" style="display:none;"><p class="heading n-blue">–õ–∏—Å—Ç–∏–Ω–≥–∏</p></div>
<div id="modalAlerts" style="display:none;"><p class="heading n-red">–ê–ª–µ—Ä—Ç—ã</p></div>
<div id="modalWallet" style="display:none;"><p class="heading n-blue">–ö–æ—à–µ–ª—ë–∫</p></div>
<div id="modalSpreads" style="display:none;"><p class="heading n-blue">–°–ø—Ä–µ–¥—ã</p></div>
<!-- NEW: Top modal template (table + horizontal buttons) -->
<!-- MODAL: Setups Pro (Scalping / Intraday) -->
<table class="top-table">
<thead>
<tr>
<th>–ú–æ–Ω–µ—Ç–∞</th>
<th>–¶–µ–Ω–∞</th>
<th>% 24—á</th>
<th>–§–∞–Ω–¥–∏–Ω–≥</th>
<th>–û–±—ä–µ–º ($)</th>
<th>–°–¥–µ–ª–∫–∏ (24—á)</th>
<th>‚≠ê üîî</th>
</tr>
</thead>
<tbody id="setupsTableBody"><tr><td colspan="7"></td></tr></tbody>
</table>
<!-- MODAL: Anomalies Pro (24h market anomalies) -->
<div id="modalSetupsAltPro" style="display:none;">
<div class="top-controls">
<div class="top-seg" id="setupsSegAlt">
<button data-mode="intraday">üìä –ò–Ω—Ç—Ä–∞–¥–µ–π</button><button data-mode="scalp">‚ö° –°–∫–∞–ª—å–ø–∏–Ω–≥</button><button class="active" data-mode="all">‚ö†Ô∏è –°–µ—Ç–∞–ø—ã 24—á</button>
<button data-mode="funding">üí∏ –§–∞–Ω–¥–∏–Ω–≥</button>
<button data-mode="basis">üìê –ë–∞–∑–∏—Å</button>
<button data-mode="volume">üìä –û–±—ä–µ–º</button>
<button data-mode="price">üìà –¶–µ–Ω–∞</button>
</div>
<span class="mini">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="setupsUpdatedAlt">‚Äî</span></span>
</div>
<table class="top-table">
<thead>
<tr>
<th>–ú–æ–Ω–µ—Ç–∞</th>
<th>–¶–µ–Ω–∞</th>
<th>% 24—á</th>
<th>–§–∞–Ω–¥–∏–Ω–≥</th>
<th>–ë–∞–∑–∏—Å %</th>
<th>–û–±—ä–µ–º ($)</th>
<th>–°–¥–µ–ª–∫–∏ (24—á)</th>
<th>‚≠ê üîî</th>
</tr>
</thead>
<tbody id="setupsTableBodyAlt"><tr><td colspan="8">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
</table>
</div>
<!-- MODAL: Listings Pro (recent & upcoming) -->
<div id="modalListingsPro" style="display:none;">
<div class="top-controls">
<div class="top-seg" id="listingsSeg">
<button class="active" data-mode="upcoming">üöÄ –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</button>
<button data-mode="recent">üÜï –ù–µ–¥–∞–≤–Ω–∏–µ</button>
</div>
<span class="mini">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="listingsUpdated">‚Äî</span></span>
</div>
<table class="top-table" id="listingsTable">
<thead>
<tr>
<th>–î–∞—Ç–∞</th>
<th>–ë–∏—Ä–∂–∞</th>
<th>–¢–æ–∫–µ–Ω</th>
<th>–ü–∞—Ä–∞</th>
<th>–¢–∏–ø</th>
<th>–ó–∞–º–µ—Ç–∫–∞</th>
</tr>
</thead>
<tbody id="listingsTableBody">
<tr><td colspan="6">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
</tbody>
</table>
</div>
<!-- MODAL: Spreads Pro - template created dynamically by spreads_autoscanner_patch_v3_1.js -->
<div id="modalTop" style="display:none;">
<div class="top-controls">
<div class="top-seg" id="topSeg">
<button class="active" data-mode="gainers">üöÄ –¢–æ–ø —Ä–æ—Å—Ç</button>
<button data-mode="losers">üìâ –¢–æ–ø –ø–∞–¥–µ–Ω–∏–µ</button>
</div>
<span class="mini">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="topUpdated">‚Äî</span></span>
</div>
<table class="top-table">
<thead>
<tr>
<th>–ú–æ–Ω–µ—Ç–∞</th>
<th>–¶–µ–Ω–∞</th>
<th>% 24—á</th>
<th>–§–∞–Ω–¥–∏–Ω–≥</th>
<th>–û–±—ä–µ–º ($)</th>
<th>–°–¥–µ–ª–∫–∏ (24—á)</th>
<th>‚≠ê üîî</th>
</tr>
</thead>
<tbody id="topTableBody"><tr><td colspan="7">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
</table>
</div>
<script>
// ===== Elements =====
const symInput = document.getElementById('sym');
const btnFind = document.getElementById('btnFind');
const btnWallet = document.getElementById('btnWallet');
const btnAlerts = document.getElementById('btnAlerts');

const btnTop = document.getElementById('btnTop');
const btnSetups = document.getElementById('btnSetups');
const btnSetupsAlt = document.getElementById('btnSetupsAlt');
const btnFav = document.getElementById('btnFav');
const btnListings = document.getElementById('btnListings');

const oiSym = document.getElementById('oiSym');

// ===== TradingView =====
function initChart(symbol = 'BINANCE:BTCUSDT', interval = '15') {
  const chartElement = document.getElementById('tvchart');
// --- Patch: enforce Binance Futures USDT-PERP symbol format ---
if(symbol && !symbol.endsWith('USDTPERP')){
  symbol = symbol.replace(/USDT$/, 'USDTPERP');
}

  if (!chartElement) return;
  chartElement.innerHTML = '';
  const colors = { background: '#12162A', grid: '#2A2E45', text: '#E0E0E0', upColor: '#00C484', downColor: '#FF647C', wickUp: '#00C484', wickDown: '#FF647C', borderUp: '#00C484', borderDown: '#FF647C', volumeUp: 'rgba(0, 196, 132, 0.4)', volumeDown: 'rgba(255, 100, 124, 0.4)'};
  new TradingView.widget({ autosize:true, symbol, interval, timezone:'Etc/UTC', theme:'dark', style:'1', locale:'ru', toolbar_bg:colors.background, enable_publishing:false, allow_symbol_change:true, container_id:'tvchart', withdateranges:true, hide_side_toolbar:false, hide_top_toolbar:false, studies:[{id:'MASimple@tv-basicstudies', inputs:{length:9}, options:{color:'#FFC107'}},{id:'Volume@tv-basicstudies', options:{volumePaneSize:'medium', color:colors.volumeUp, color_0:colors.volumeDown}},{id:'RSI@tv-basicstudies', inputs:{length:14}, options:{plotColor:'#8B5CF6', upperBandColor:'#4A4D5E', lowerBandColor:'#4A4D5E'}, customTitle:'RSI 14 close'},{id:'MACD@tv-basicstudies', inputs:{fastLength:12, slowLength:26, signalLength:9}, options:{macdLineColor:'#38BDF8', signalLineColor:'#FFC107', histUpColor:colors.upColor, histDownColor:colors.downColor}, customTitle:'MACD 12 26 close 9'}], overrides:{'paneProperties.background':colors.background,'paneProperties.vertGridProperties.color':colors.grid,'paneProperties.horzGridProperties.color':colors.grid,'symbolWatermarkProperties.color':'rgba(0,0,0,0)','scalesProperties.textColor':colors.text,'mainSeriesProperties.candleStyle.upColor':colors.upColor,'mainSeriesProperties.candleStyle.downColor':colors.downColor,'mainSeriesProperties.candleStyle.drawWick':true,'mainSeriesProperties.candleStyle.drawBorder':true,'mainSeriesProperties.candleStyle.wickUpColor':colors.wickUp,'mainSeriesProperties.candleStyle.wickDownColor':colors.wickDown,'mainSeriesProperties.candleStyle.borderUpColor':colors.borderUp,'mainSeriesProperties.candleStyle.borderDownColor':colors.borderDown}});
}
document.addEventListener('DOMContentLoaded', () => initChart());
btnFind.addEventListener('click', () => { 
  const val = symInput.value.toUpperCase().trim();
  const tvSym = val.includes(':') ? val : 'BINANCE:' + val;
  initChart(tvSym);
  // Also notify other modules (Agent + OI)
  let raw = val.replace(/^BINANCE:/,'');
  // Normalize symbol for futures: prefer ...USDT (API) and ...USDTPERP (TV)
  if(raw.endsWith('USDTPERP')) raw = raw.replace(/USDTPERP$/,'USDT');
  if(!/USDT$/.test(raw)) raw = raw + 'USDT';
  window.dispatchEvent(new CustomEvent('symbol-picked', { detail:{ symbol: raw } }));
});

btnWallet.addEventListener('click', () => openModal('üí∞ –ö–æ—à–µ–ª—ë–∫', 'modalWallet'));
btnSettings.addEventListener('click', () => openModal('üìä –°–ø—Ä–µ–¥—ã', 'modalSpreadsPro'));
btnAlerts.addEventListener('click', () => openModal('üîî –ê–ª–µ—Ä—Ç—ã', 'modalAlerts'));

// ===== Modal =====
const modalDrawer = document.getElementById('modalDrawer');
const modalTitle = document.getElementById('modalTitle');
const modalContent = document.getElementById('modalContent');
const closeModalBtn = document.getElementById('closeModalBtn');
function openModal(title, contentId){ modalTitle.textContent = title; modalContent.innerHTML=''; const tpl = document.getElementById(contentId); if(tpl){ const c = tpl.cloneNode(true); c.style.display='block'; modalContent.appendChild(c);} modalDrawer.classList.add('show'); }
function closeModal(){ modalDrawer.classList.remove('show'); }
closeModalBtn.addEventListener('click', closeModal);

// ====== TOP via Binance Futures (USDT perpetual) ======
const TICKER_URL = 'wss://fstream.binance.com/ws/!ticker@arr';
const MARK_URL   = 'wss://fstream.binance.com/ws/!markPrice@arr';
let tickerWS, markWS;
let tickerMap = new Map();  // s -> 24h ticker (c, P, q, n)
let fundingMap = new Map(); // s -> mark data (r)
let mode = 'gainers';
let lastRender = 0;

function startTopWS(){
  if(tickerWS && markWS) return;
  tickerWS = new WebSocket(TICKER_URL);
  tickerWS.onmessage = (ev)=>{
    const arr = JSON.parse(ev.data);
    if(Array.isArray(arr)){
      for(const t of arr){
        const s = t.s;
        if(!s || !s.endsWith('USDT')) continue; // —Ç–æ–ª—å–∫–æ USDT perpetual
        tickerMap.set(s, t);
      }
      scheduleTopRender();
    }
  };
  tickerWS.onclose = ()=>{ tickerWS = null; setTimeout(startTopWS, 1500); };

  markWS = new WebSocket(MARK_URL);
  markWS.onmessage = (ev)=>{
    const arr = JSON.parse(ev.data);
    if(Array.isArray(arr)){
      for(const m of arr){
        const s = m.s;
        if(!s || !s.endsWith('USDT')) continue;
        fundingMap.set(s, m);
      }
      scheduleTopRender();
    }
  };
  markWS.onclose = ()=>{ markWS = null; setTimeout(startTopWS, 1500); };
}

function scheduleTopRender(){
  const now = Date.now();
  if(now - lastRender > 800){
    lastRender = now;
    if(document.getElementById('topTableBody')) renderTop();
    const upd = document.querySelector('#modalContent #topUpdated');
    if(upd) upd.textContent = new Date().toLocaleTimeString();
  }
}

function initTopUI(){
  const seg = document.querySelector('#modalContent #topSeg');
  if(!seg) return;
  seg.querySelectorAll('button').forEach(btn=>{
    btn.onclick = ()=>{
      seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      mode = btn.dataset.mode;
      renderTop();
    };
  });
}

function getRows(){
  const rows = [];
  tickerMap.forEach((t,s)=>{
    const price = Number(t.c);
    const pct = Number(t.P);
    const qv = Number(t.q);
    const trades = Number(t.n || t.N || 0);
    const fund = Number((fundingMap.get(s)?.r) ?? 0);
    rows.push({ symbol:s, price, pct, funding:fund, volume:qv, trades });
  });
  return rows;
}
function sortRows(rows){
  if(mode==='gainers') return rows.sort((a,b)=> b.pct - a.pct).slice(0,100);
  return rows.sort((a,b)=> a.pct - b.pct).slice(0,100);
}
function num(v,d=2){ if(!isFinite(v)) return '‚Äî'; return v.toLocaleString(undefined,{maximumFractionDigits:d}); }
function pct(v){ if(!isFinite(v)) return '‚Äî'; return (v>=0?'+':'') + v.toFixed(2) + '%'; }
function fundFmt(v){ if(!isFinite(v)) return '‚Äî'; return (v>=0?'+':'') + (v*100).toFixed(4) + '%'; }

function isFav(sym){ try{ return new Set(JSON.parse(localStorage.getItem('favs')||'[]')).has(sym); }catch{ return false; } }
function toggleFav(sym){ const set = new Set(JSON.parse(localStorage.getItem('favs')||'[]')); set.has(sym)?set.delete(sym):set.add(sym); localStorage.setItem('favs', JSON.stringify([...set])); }
function toggleAlert(sym){ const set = new Set(JSON.parse(localStorage.getItem('alerts')||'[]')); set.has(sym)?set.delete(sym):set.add(sym); localStorage.setItem('alerts', JSON.stringify([...set])); alert('–ê–ª–µ—Ä—Ç –¥–ª—è '+sym+' '+(set.has(sym)?'–≤–∫–ª—é—á—ë–Ω':'–≤—ã–∫–ª—é—á–µ–Ω')); }

function onPickSymbol(sym){
  // –ì—Ä–∞—Ñ–∏–∫
  initChart('BINANCE:'+sym);
  // OI –∑–∞–≥–æ–ª–æ–≤–æ–∫
  oiSym.textContent = sym;
  // –°–æ–±—ã—Ç–∏–µ –¥–ª—è –≤–∞—à–∏—Ö –ø–æ–¥—Å–∏—Å—Ç–µ–º
  window.dispatchEvent(new CustomEvent('symbol-picked', { detail:{ symbol:sym } }));
  closeModal();
}

function renderTop(){
  const tbody = document.querySelector('#modalContent #topTableBody');
  if(!tbody) return;
  const rows = sortRows(getRows());
  const favs = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
  const alerts = new Set(JSON.parse(localStorage.getItem('alerts')||'[]'));
  tbody.innerHTML = '';
  for(const r of rows){
    const tr = document.createElement('tr');
    const tdSym = document.createElement('td'); tdSym.className='top-symbol'; tdSym.textContent = r.symbol; tdSym.onclick = ()=> onPickSymbol(r.symbol); tr.appendChild(tdSym);
    const tdP = document.createElement('td'); tdP.className='mono'; tdP.textContent = num(r.price, r.price<1?6:2); tr.appendChild(tdP);
    const tdPct = document.createElement('td'); tdPct.textContent = pct(r.pct); tdPct.className = r.pct>=0?'top-value-green':'top-value-red'; tr.appendChild(tdPct);
    const tdF = document.createElement('td'); tdF.className='mono'; tdF.textContent = fundFmt(r.funding); tr.appendChild(tdF);
    const tdV = document.createElement('td'); tdV.className='mono'; tdV.textContent = num(r.volume,0); tr.appendChild(tdV);
    const tdN = document.createElement('td'); tdN.className='mono'; tdN.textContent = num(r.trades,0); tr.appendChild(tdN);
    const tdA = document.createElement('td');
      const star = document.createElement('button'); star.className='emoji-btn'+(favs.has(r.symbol)?' active':''); star.textContent='‚≠ê'; star.title='–ò–∑–±—Ä–∞–Ω–Ω–æ–µ'; star.onclick = (e)=>{ e.stopPropagation(); toggleFav(r.symbol); renderTop(); };
      const bell = document.createElement('button'); bell.className='emoji-btn'+(alerts.has(r.symbol)?' active':''); bell.textContent='üîî'; bell.title='–ê–ª–µ—Ä—Ç'; bell.onclick = (e)=>{ e.stopPropagation(); toggleAlert(r.symbol); renderTop(); };
      tdA.appendChild(star); tdA.appendChild(bell);
    tr.appendChild(tdA);
    tbody.appendChild(tr);
  }
}

// Open modal with Top table
btnTop.addEventListener('click', () => {
  openModal('üìà –¢–æ–ø (Binance Futures 24—á)', 'modalTop');
  initTopUI();
  startTopWS();
  renderTop();
});
btnSetups.addEventListener("click", () => openModal("ü§ñ –¢–µ–ª–µ–±–æ—Ç", "modalSetups"));
btnSetupsAlt.addEventListener('click', () => openModal('üì° –°–µ—Ç–∞–ø—ã', 'modalSetupsAlt'));
btnFav.addEventListener('click', () => openModal('‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ', 'modalFavorites'));
btnListings.addEventListener('click', () => openModal('üöÄ –õ–∏—Å—Ç–∏–Ω–≥–∏', 'modalListings'));

// Dummy fill to show UI
setTimeout(()=>{
  const setText = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
  setText('priceV','107,570.3'); setText('entryV','107,922.0'); setText('slV','107,570.3'); setText('tpV','109,000.0'); setText('rrV','2.4'); setText('sidePill','LONG');
}, 800);</script>
<script>
// === Inlined ByAgent Trading AI (LONG/SHORT + SL/TP) ===
(function(){
  const API = 'https://fapi.binance.com';
  const STATE = { symbol: 'BTCUSDT', interval: '15m', timer: null, refreshMs: 60_000, lastCalc: null };

  // ----- helpers -----
  const ema = (arr, p)=>{ const k=2/(p+1); let out=[],e=arr[0]; for(let i=0;i<arr.length;i++){ e = arr[i]*k + e*(1-k); out.push(e);} return out; };
  const rsi = (c, p=14)=>{ let gains=0, losses=0, out=[NaN]; for(let i=1;i<c.length;i++){ const ch=c[i]-c[i-1]; gains+=Math.max(0,ch); losses+=Math.max(0,-ch);
    if(i==p){ const g=gains/p, l=losses/p, rs=l===0?100:g/l; out.push(100-100/(1+rs)); out._g=g; out._l=l; }
    else if(i>p){ const g=Math.max(0,ch), l=Math.max(0,-ch); out._g = (out._g*(p-1)+g)/p; out._l = (out._l*(p-1)+l)/p; const rs=out._l===0?100:out._g/out._l; out.push(100-100/(1+rs)); }
    else out.push(NaN);
  } return out; };
  const macd = (c, f=12, s=26, sig=9)=>{ const ef=ema(c,f), es=ema(c,s); const m=ef.map((v,i)=>v-es[i]); const sg=ema(m,sig); const h=m.map((v,i)=>v-sg[i]); return {m,sg,h}; };
  const trueRange=(h,l,c)=>h.map((v,i)=> i? Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])) : h[0]-l[0]);
  const atr=(h,l,c,p=14)=>{ const tr=trueRange(h,l,c); const out=[]; let sum=0; for(let i=0;i<tr.length;i++){ sum+=tr[i]; if(i>=p) sum-=tr[i-p]; out.push(i>=p-1? sum/p : NaN);} return out; };
  const fmt=(v,dp=2)=> (!isFinite(v)||v==null)?'‚Äî':Number(v).toLocaleString(undefined,{maximumFractionDigits:dp});
  const setText=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
  const addClass=(id,cls)=>{ const el=document.getElementById(id); if(!el) return; el.classList.add(cls); };
  const remColor=(el)=>{ el.classList.remove('n-green','n-red','top-value-green','top-value-red'); };

  function colorize(calc){
    const priceEl = document.getElementById('priceV');
    const entryEl = document.getElementById('entryV');
    const slEl = document.getElementById('slV');
    const tpEl = document.getElementById('tpV');
    const rrEl = document.getElementById('rrV');
    const sideEl = document.getElementById('sidePill');

    ;[priceEl,entryEl,slEl,tpEl,rrEl,sideEl].filter(Boolean).forEach(remColor);

    // Side pill: LONG green, SHORT red
    if(sideEl){ sideEl.textContent = calc.side; sideEl.classList.add(calc.side==='LONG'?'n-green':'n-red'); }

    // TP –∑–µ–ª—ë–Ω—ã–π, SL –∫—Ä–∞—Å–Ω—ã–π
    if(tpEl) tpEl.classList.add('n-green');
    if(slEl) slEl.classList.add('n-red');

    // RR: –¥–ª—è LONG –∑–µ–ª—ë–Ω—ã–π, –¥–ª—è SHORT –∫—Ä–∞—Å–Ω—ã–π
    if(rrEl) rrEl.classList.add(calc.side==='LONG'?'n-green':'n-red');
  }

  async function fetchKlines(symbol, interval, limit=500){
    const u = `${API}/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
    const r = await fetch(u); if(!r.ok) throw new Error('Binance '+r.status);
    const raw = await r.json();
    const o=raw.map(r=>+r[1]), h=raw.map(r=>+r[2]), l=raw.map(r=>+r[3]), c=raw.map(r=>+r[4]), v=raw.map(r=>+r[5]);
    return {o,h,l,c,v};
  }

  function decide({h,l,c}){
    const last=c[c.length-1], prev=c[c.length-2];
    const e9=ema(c,9), e21=ema(c,21), e50=ema(c,50);
    const rs=rsi(c,14); const m=macd(c,12,26,9); const a=atr(h,l,c,14);
    const lastE9=e9.at(-1), lastE21=e21.at(-1), lastE50=e50.at(-1);
    const lastRSI=rs.at(-1), lastMACD=m.m.at(-1), lastSig=m.sg.at(-1), lastHist=m.h.at(-1), lastATR=a.at(-1);

    let bull=0, bear=0;
    if(lastE9>lastE21 && lastE21>lastE50) bull+=2;
    if(lastE9<lastE21 && lastE21<lastE50) bear+=2;
    if(last>lastE21) bull+=1; else bear+=1;
    if(lastMACD>lastSig) bull+=1; else bear+=1;
    if(lastHist>0 && lastHist>m.h.at(-2)) bull+=1;
    if(lastHist<0 && lastHist<m.h.at(-2)) bear+=1;
    if(lastRSI>55) bull+=1; if(lastRSI<45) bear+=1;
    if(lastRSI<30) bull+=0.5; if(lastRSI>70) bear+=0.5;
    if(last>prev) bull+=0.25; else bear+=0.25;

    const side = bull>bear ? 'LONG' : (bear>bull ? 'SHORT' : (last>=lastE21?'LONG':'SHORT'));
    const kSL = 1.5, RR = 2.0;
    const entry = last;
    let sl,tp;
    if(side==='LONG'){ sl = entry - kSL*lastATR; tp = entry + RR*(entry-sl); }
    else { sl = entry + kSL*lastATR; tp = entry - RR*(sl-entry); }

    return { side, entry, sl, tp, rr: RR, context:{ last }, atr:lastATR };
  }

  function write(calc){
    setText('priceV', fmt(calc.context.last, calc.context.last<1?6:2));
    setText('entryV', fmt(calc.entry, calc.entry<1?6:2));
    setText('slV',    fmt(calc.sl,    calc.sl<1?6:2));
    setText('tpV',    fmt(calc.tp,    calc.tp<1?6:2));
    setText('rrV',    fmt(calc.rr, 2));
    colorize(calc);
  }

  async function recalc(){
    try{
      const sym = (STATE.symbol.endsWith('USDT')?STATE.symbol:STATE.symbol.replace(/USDTPERP$/,'USDT'));
      const data = await fetchKlines(sym, STATE.interval, 500);
      const calc = decide(data);
      STATE.lastCalc = calc;
      write(calc);
    }catch(e){ console.error('Agent error:', e); }
  }

  function start(){ if(STATE.timer) clearInterval(STATE.timer); recalc(); STATE.timer = setInterval(recalc, STATE.refreshMs); }

  // react to your "Top" selection
  window.addEventListener('symbol-picked', (ev)=>{
    const s = ev?.detail?.symbol; if(!s) return;
    STATE.symbol = String(s).toUpperCase().replace(/[^A-Z0-9]/g,'');
    const oi = document.getElementById('oiSym'); if(oi) oi.textContent = STATE.symbol;
    start();
  });

  document.addEventListener('DOMContentLoaded', ()=>{
    const oi = document.getElementById('oiSym'); if(oi && oi.textContent) STATE.symbol = oi.textContent.trim();
    start();
    // safety re-run after possible UI scripts
    setTimeout(start, 1200);
  });
})();
</script>
<script>
// === Open Interest (OI) live data for Binance Futures USDT perpetual ===
(function(){
  const API = 'https://fapi.binance.com';
  const STATE = {
    symbol: (document.getElementById('oiSym')?.textContent || 'BTCUSDT').trim().toUpperCase(),
    period: '5m',           // '5m' | '15m' | '1h' (mapped to Binance 'period')
    timer: null,
    refreshMs: 60_000
  };

  // Map UI buttons
  const btnSeg = document.getElementById('oiTimeSeg');
  function onPeriodClick(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    btnSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    STATE.period = btn.dataset.time || '5m';
    refreshOI();
  }
  if(btnSeg){ btnSeg.addEventListener('click', onPeriodClick); }

  // DOM helpers
  const el = (id)=>document.getElementById(id);
  const set = (id,val)=>{ const n=el(id); if(n) n.textContent = val; };
  const fmt = (v, d=2)=> (v==null||!isFinite(v)) ? '‚Äî' : Number(v).toLocaleString(undefined,{maximumFractionDigits:d});
  const sgn = (v)=> (v>0?'+':'') + (isFinite(v)?v.toLocaleString(undefined,{maximumFractionDigits:2}):'‚Äî');

  
  function colorizeValue(node, value){
    if(!node) return;
    node.classList.remove('n-green','n-red','n-blue','top-value-green','top-value-red');
    if(!isFinite(value) || value === 0){ node.classList.add('n-blue'); return; }
    if(value>0) node.classList.add('n-green'); else node.classList.add('n-red');
  }

  // --- Binance fetchers ---
  async function fetchOpenInterestNow(symbol){
    const u = `${API}/fapi/v1/openInterest?symbol=${symbol}`;
    const r = await fetch(u);
    if(!r.ok) throw new Error('openInterest '+r.status);
    const j = await r.json();
    return Number(j.openInterest);
  }
  async function fetchOpenInterestHist(symbol, period, limit=3){
    const u = `${API}/futures/data/openInterestHist?symbol=${symbol}&period=${period}&limit=${limit}`;
    const r = await fetch(u);
    if(!r.ok) throw new Error('openInterestHist '+r.status);
    return await r.json(); // [{sumOpenInterest, timestamp}, ...]
  }
  async function fetchTakerVolumes(symbol, period, limit=2){
    const u = `${API}/futures/data/takerlongshortRatio?symbol=${symbol}&period=${period}&limit=${limit}&contractType=PERPETUAL`;
    const r = await fetch(u);
    if(!r.ok) throw new Error('takerlongshortRatio '+r.status);
    return await r.json(); // [{buyVol, sellVol, ...}, ...]
  }

  function normalizeSymbol(sym){
    let s = String(sym||'').toUpperCase();
    s = s.replace(/[^A-Z0-9]/g,'');
    if(s.endsWith('USDTPERP')) s = s.replace(/USDTPERP$/,'USDT');
    if(!/USDT$/.test(s)) s = s + 'USDT';
    return s;
  }

  async function updateOI(){
    const symbol = STATE.symbol;
    const period = STATE.period;
    try{
      const [oiNow, oiHist, takers] = await Promise.all([
        fetchOpenInterestNow(symbol),
        fetchOpenInterestHist(symbol, period, 6),
        fetchTakerVolumes(symbol, period, 1)
      ]);
      // OI now
      set('oiNowV', fmt(oiNow, 0));

      // OI delta vs prev (using last two hist points)
      let delta = NaN;
      if(Array.isArray(oiHist) && oiHist.length>=2){
        const prev = Number(oiHist[oiHist.length-2].sumOpenInterest);
        const last = Number(oiHist[oiHist.length-1].sumOpenInterest);
        delta = last - prev;
        const node = el('oiDeltaV');
        if(node){ node.textContent = sgn(delta); colorizeValue(node, delta); }
      }else{
        set('oiDeltaV','‚Äî');
      }

      
      // Taker Buy/Sell and Total for period (–∏ –æ–∫—Ä–∞—Å–∫–∞ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
      if(Array.isArray(takers) && takers.length){
        const last = takers[takers.length-1];
        const prev = takers.length>1 ? takers[takers.length-2] : null;
        const buy = Number(last.buyVol);
        const sell = Number(last.sellVol);
        const prevBuy = prev ? Number(prev.buyVol) : NaN;
        const prevSell = prev ? Number(prev.sellVol) : NaN;
        set('takerBuyV', fmt(buy, 0));
        set('takerSellV', fmt(sell, 0));
        colorizeValue(el('takerBuyV'), isFinite(prevBuy) ? buy-prevBuy : 0);
        colorizeValue(el('takerSellV'), isFinite(prevSell) ? sell-prevSell : 0);

        const total = (isFinite(buy)?buy:0) + (isFinite(sell)?sell:0);
        const prevTotal = (isFinite(prevBuy)?prevBuy:0) + (isFinite(prevSell)?prevSell:0);
        const totalNode = el('oiTotalV');
        if(totalNode){
          totalNode.textContent = fmt(total, 0);
          colorizeValue(totalNode, (isFinite(prevTotal) ? total - prevTotal : 0));
        }
      }else{
        set('takerBuyV','‚Äî'); set('takerSellV','‚Äî'); set('oiTotalV','‚Äî');
        colorizeValue(el('takerBuyV'), 0); colorizeValue(el('takerSellV'), 0); colorizeValue(el('oiTotalV'), 0);
      }

      // OI Now –≤—Å–µ–≥–¥–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–∏–Ω–∏–π
      const oiNowNode = el('oiNowV'); if(oiNowNode){ oiNowNode.classList.remove('n-green','n-red'); oiNowNode.classList.add('n-blue'); }

      set('oiUpdatedV', new Date().toLocaleTimeString());

    }catch(err){
      console.error('OI update error', err);
      // keep UI graceful
    }
  }

  function refreshOI(){
    if(STATE.timer) clearInterval(STATE.timer);
    updateOI();
    STATE.timer = setInterval(updateOI, STATE.refreshMs);
  }

  // React to symbol changes from search / top
  window.addEventListener('symbol-picked', (ev)=>{
    const sym = normalizeSymbol(ev?.detail?.symbol || '');
    if(sym && sym!==STATE.symbol){
      STATE.symbol = sym;
      const title = document.getElementById('oiSym');
      if(title){ title.textContent = STATE.symbol; }
      refreshOI();
    }
  });

  // Kick off on load
  document.addEventListener('DOMContentLoaded', ()=>{
    STATE.symbol = normalizeSymbol(STATE.symbol);
    const title = document.getElementById('oiSym');
    if(title){ title.textContent = STATE.symbol; }
    refreshOI();
  });
})();
</script>
<style>
/* –£—Å–∏–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ LONG/SHORT, POSITIVE/NEGATIVE */
.n-green {
  color: var(--green);
  font-weight: 800;
  text-shadow: 0 0 12px rgba(34,197,94,.7), 0 0 25px rgba(34,197,94,.5);
}
.n-red {
  color: var(--red);
  font-weight: 800;
  text-shadow: 0 0 12px rgba(239,68,68,.7), 0 0 25px rgba(239,68,68,.5);
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–ª–æ–≤ –í—Ö–æ–¥, –¶–µ–Ω–∞ –∏ –í—Å–µ–≥–æ */
.info-box-label:has-text("–í—Ö–æ–¥"),
.info-box-label:has-text("–¶–µ–Ω–∞"),
.oi-label:has-text("–í—Å–µ–≥–æ") {
  color: var(--blue);
  font-weight: 700;
  text-shadow: 0 0 10px rgba(56,189,248,.5);
}
</style>
<script>
// === –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ===
function renderFavorites(){
  const favBox = document.querySelector('#modalContent #modalFavorites');
  if(!favBox) return;
  const favs = JSON.parse(localStorage.getItem('favs') || '[]');
  favBox.innerHTML = `<p class="heading n-green">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</p>`;
  if(!favs.length){ favBox.innerHTML += '<p class="mini">–ü—É—Å—Ç–æ</p>'; return; }
  const ul = document.createElement('ul');
  ul.style.listStyle='none'; ul.style.padding='0';
  favs.forEach(sym=>{
    const li=document.createElement('li');
    li.innerHTML=`üëÜ <b>${sym}</b> <button class="emoji-btn" title="–£–¥–∞–ª–∏—Ç—å">‚ùå</button>`;
    li.querySelector('button').onclick=(e)=>{e.stopPropagation();toggleFav(sym);renderFavorites();};
    li.onclick=()=>onPickSymbol(sym);
    ul.appendChild(li);
  });
  favBox.appendChild(ul);
}

function toggleFav(sym){
  const set = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
  set.has(sym)?set.delete(sym):set.add(sym);
  localStorage.setItem('favs', JSON.stringify([...set]));
  renderFavorites(); // –æ–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
}

// –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫–Ω–æ–ø–∫–∏ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
btnFav.addEventListener('click', () => {
  openModal('‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ', 'modalFavorites');
  renderFavorites();
});
</script>
<style>
/* === –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è Taker Buy/Sell === */
.oi-card .oi-row .oi-label.taker-buy-label { 
  color: var(--green); 
  text-shadow: 0 0 10px rgba(34,197,94,.5);
}
.oi-card .oi-row .oi-label.taker-sell-label { 
  color: var(--red); 
  text-shadow: 0 0 10px rgba(239,68,68,.5);
}
</style>
<script>

// === –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–∏–Ω–≥–∞ —É Taker Buy/Sell ===
(function(){
  const timeSeg = document.getElementById('oiTimeSeg');
  function updateLabels(period){
    document.querySelectorAll('.oi-label').forEach(label=>{
      if(label.textContent.includes('Taker Buy'))
        label.innerHTML = `Taker Buy (${period})`;
      if(label.textContent.includes('Taker Sell'))
        label.innerHTML = `Taker Sell (${period})`;
      if(label.textContent.includes('–í—Å–µ–≥–æ'))
        label.innerHTML = `–í—Å–µ–≥–æ (Buy+Sell, ${period})`;
    });
  }
  if(timeSeg){
    timeSeg.addEventListener('click', e=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      updateLabels(btn.dataset.time);
    });
  }
})();
</script>
<style>

/* === Precise animated color shift (no blur, no neon) === */
@keyframes smoothShiftGreen {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}
@keyframes smoothShiftBlue {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}
@keyframes smoothShiftRed {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* buttons: only text (letters) animated subtle green gradient */
.button-grid #btnSetups,
.button-grid #btnSetupsAlt,
.button-grid #btnTop,
.button-grid #btnAlerts,
.button-grid #btnFav,
.button-grid #btnListings {
  background-image: linear-gradient(270deg, #00b86b, #00e07a, #00b86b);
  background-size: 200% 200%;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: smoothShiftGreen 5s linear infinite;
  font-weight: 900;
}

/* general colored text/values (sharp readable color animation, same speed) */
.n-blue, .n-green, .n-red, .top-value-green, .top-value-red {
  font-weight: 800;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 200% 200%;
}

/* blue range */
.n-blue {
  background-image: linear-gradient(270deg, #1d9bf0, #50b8ff, #1d9bf0);
  animation: smoothShiftBlue 5s linear infinite;
}

/* green range */
.n-green, .top-value-green {
  background-image: linear-gradient(270deg, #00b86b, #00e07a, #00b86b);
  animation: smoothShiftGreen 5s linear infinite;
}

/* red range */
.n-red, .top-value-red {
  background-image: linear-gradient(270deg, #ff4757, #ff6b81, #ff4757);
  animation: smoothShiftRed 5s linear infinite;
}

</style>
<style>

/* === Final sharp & contrast color animations (5s) === */
@keyframes smoothShiftBlue {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}
@keyframes smoothShiftGreen {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}
@keyframes smoothShiftRed {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* all colored texts and numbers (outside buttons) */
.n-blue, .n-green, .n-red, .top-value-green, .top-value-red {
  font-weight: 900;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 250% 250%;
}

/* Blue range - clear and vivid */
.n-blue {
  background-image: linear-gradient(270deg, #0d8cf0, #45b4ff, #0d8cf0);
  animation: smoothShiftBlue 5s linear infinite;
}

/* Green range - crisp middle green range */
.n-green, .top-value-green {
  background-image: linear-gradient(270deg, #00a95a, #00e67a, #00a95a);
  animation: smoothShiftGreen 5s linear infinite;
}

/* Red range - rich, contrast red range */
.n-red, .top-value-red {
  background-image: linear-gradient(270deg, #ff3344, #ff7084, #ff3344);
  animation: smoothShiftRed 5s linear infinite;
}

/* Buttons remain unchanged (preserve existing design) */

</style>
<style>

/* === Ultra-clear, high-contrast color animation (no glow, no blur) === */
@keyframes strongShiftBlue {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}
@keyframes strongShiftGreen {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}
@keyframes strongShiftRed {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* universal crisp animated gradient for colored texts */
.n-blue, .n-green, .n-red, .top-value-green, .top-value-red {
  font-weight: 900;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 250% 250%;
  text-shadow: none; /* ensure sharpness */
}

/* deep saturated blue */
.n-blue {
  background-image: linear-gradient(270deg, #0077ff, #4db8ff, #0077ff);
  animation: strongShiftBlue 5s linear infinite;
}

/* vivid medium green */
.n-green, .top-value-green {
  background-image: linear-gradient(270deg, #00c46a, #00ff8c, #00c46a);
  animation: strongShiftGreen 5s linear infinite;
}

/* intense red */
.n-red, .top-value-red {
  background-image: linear-gradient(270deg, #ff1f3d, #ff6b81, #ff1f3d);
  animation: strongShiftRed 5s linear infinite;
}

/* ensure readability on dark backgrounds */
.n-blue, .n-green, .n-red, .top-value-green, .top-value-red {
  filter: contrast(1.15) brightness(1.05);
}

</style>
<style>

/* === Final version: wider range, clear text, includes '–í—Ö–æ–¥' and '–¶–µ–Ω–∞' === */
@keyframes vividShiftBlue {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}
@keyframes vividShiftGreen {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}
@keyframes vividShiftRed {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* General vivid text styles */
.n-blue, .n-green, .n-red, .top-value-green, .top-value-red,
.value-blue, .value-green, .value-red {
  font-weight: 900;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 300% 300%;
  filter: contrast(1.2) brightness(1.08);
}

/* Widened range ‚Äî strong, readable tones */
.n-blue, .value-blue {
  background-image: linear-gradient(270deg, #0064ff, #57bfff, #004fcc);
  animation: vividShiftBlue 5s linear infinite;
}

.n-green, .top-value-green, .value-green {
  background-image: linear-gradient(270deg, #00a653, #00ff91, #007a3d);
  animation: vividShiftGreen 5s linear infinite;
}

.n-red, .top-value-red, .value-red {
  background-image: linear-gradient(270deg, #ff1233, #ff7a88, #b8001e);
  animation: vividShiftRed 5s linear infinite;
}

/* Make sure entry/price values adopt same vivid style */
.value-field, .entry-value, .price-value {
  background-image: linear-gradient(270deg, #00a653, #00ff91, #007a3d);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: vividShiftGreen 5s linear infinite;
  font-weight: 900;
  filter: contrast(1.2) brightness(1.08);
}

</style>
<style>

/* === Final refined smooth animation: contrast, no blur, includes '–í—Ö–æ–¥' –∏ '–¶–µ–Ω–∞' === */

/* soft infinite flow animation, no jumps */
@keyframes smoothFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* shared base for all colored text */
.n-blue, .n-green, .n-red, .top-value-green, .top-value-red,
.value-blue, .value-green, .value-red,
.value-field, .entry-value, .price-value,
.entry-label, .price-label {
  font-weight: 900;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 250% 250%;
  animation: smoothFlow 5s ease-in-out infinite;
  text-shadow: none;
  filter: contrast(1.25) brightness(1.1);
}

/* vivid blue */
.n-blue, .value-blue {
  background-image: linear-gradient(270deg, #0064ff, #4db8ff, #0064ff);
}

/* vivid green */
.n-green, .top-value-green, .value-green,
.value-field, .entry-value, .price-value,
.entry-label, .price-label {
  background-image: linear-gradient(270deg, #00b55d, #00ff94, #00b55d);
}

/* vivid red */
.n-red, .top-value-red, .value-red {
  background-image: linear-gradient(270deg, #ff1e3d, #ff7684, #ff1e3d);
}

/* ensure '–í—Ö–æ–¥' –∏ '–¶–µ–Ω–∞' remain perfectly readable and crisp */
.entry-label, .price-label, .entry-value, .price-value {
  font-weight: 900;
  letter-spacing: 0.3px;
  filter: contrast(1.3) brightness(1.08);
}

</style>
<style>

/* === FINAL: Entry & Price = same blue style as "Open Interest ‚Äî BTCUSDT" === */
@keyframes smoothFlowBlue {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* crisp rendering */
.entry-label, .price-label, .entry-value, .price-value {
  font-weight: 900;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 250% 250%;
  animation: smoothFlowBlue 5s ease-in-out infinite;
  background-image: linear-gradient(270deg, #0072ff, #33aaff, #0050cc);
  filter: contrast(1.25) brightness(1.08);
  -webkit-text-stroke: 0.4px rgba(0,0,0,0.25);
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: none;
  font-smooth: never;
}

</style>
<style>
/* === FIX: Entry & Price values ‚Äî sharp, same as Open Interest === */
#entryV, #priceV {
  font-weight: 900;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-image: linear-gradient(270deg, #0072ff, #33aaff, #0050cc);
  background-size: 250% 250%;
  animation: smoothFlowBlue 5s ease-in-out infinite;
  filter: contrast(1.3) brightness(1.1);
  -webkit-text-stroke: 0.4px rgba(0,0,0,0.25);
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: none;
  font-smooth: never;
  text-shadow: none !important;
}

/* label names "–í—Ö–æ–¥" –∏ "–¶–µ–Ω–∞" ‚Äî same tone, no blur */
.info-box-label:has-text("–í—Ö–æ–¥"),
.info-box-label:has-text("–¶–µ–Ω–∞") {
  color: #33aaff;
  font-weight: 800;
  text-shadow: none;
}
</style>
<style>
/* === FIX: Equal bell icon style (no extra glow/brightness) === */
.emoji-btn {
  font-size: 16px !important;
  filter: saturate(1) brightness(1) !important;
  opacity: 0.9 !important;
  transition: transform 0.2s ease, opacity 0.2s ease;
}
.emoji-btn.active {
  opacity: 1 !important;
  transform: scale(1.15);
  filter: brightness(1.3) saturate(1.2);
}
</style>
<script>
// === PATCH: Favorites toggle + uniform bell style ===

// Unified functions (safe override without touching other logic)
function renderFavorites(){
  const favBox = document.querySelector('#modalContent #modalFavorites');
  if(!favBox) return;
  const favs = JSON.parse(localStorage.getItem('favs') || '[]');
  favBox.innerHTML = `<p class="heading n-green">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</p>`;
  if(!favs.length){
    favBox.innerHTML += '<p class="mini">–ü—É—Å—Ç–æ</p>';
    return;
  }
  const ul = document.createElement('ul');
  ul.style.listStyle='none';
  ul.style.padding='0';
  favs.forEach(sym => {
    const li = document.createElement('li');
    li.innerHTML = `üëÜ <b>${sym}</b> <button class="emoji-btn" title="–£–¥–∞–ª–∏—Ç—å">‚ùå</button>`;
    li.querySelector('button').onclick = (e) => {
      e.stopPropagation();
      toggleFav(sym);
      renderFavorites();
    };
    li.onclick = () => onPickSymbol(sym);
    ul.appendChild(li);
  });
  favBox.appendChild(ul);
}

function toggleFav(sym){
  const set = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
  if(set.has(sym)) set.delete(sym); else set.add(sym);
  localStorage.setItem('favs', JSON.stringify([...set]));
  renderFavorites();
}

// override Top render (for star behavior only)
const _oldRenderTop = renderTop;
renderTop = function(){
  const tbody = document.querySelector('#modalContent #topTableBody');
  if(!tbody) return;
  const rows = sortRows(getRows());
  const favs = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
  const alerts = new Set(JSON.parse(localStorage.getItem('alerts')||'[]'));
  tbody.innerHTML = '';
  for(const r of rows){
    const tr = document.createElement('tr');
    const tdSym = document.createElement('td');
    tdSym.className='top-symbol';
    tdSym.textContent = r.symbol;
    tdSym.onclick = ()=> onPickSymbol(r.symbol);
    tr.appendChild(tdSym);
    const tdP = document.createElement('td');
    tdP.className='mono';
    tdP.textContent = num(r.price, r.price<1?6:2);
    tr.appendChild(tdP);
    const tdPct = document.createElement('td');
    tdPct.textContent = pct(r.pct);
    tdPct.className = r.pct>=0?'top-value-green':'top-value-red';
    tr.appendChild(tdPct);
    const tdF = document.createElement('td');
    tdF.className='mono';
    tdF.textContent = fundFmt(r.funding);
    tr.appendChild(tdF);
    const tdV = document.createElement('td');
    tdV.className='mono';
    tdV.textContent = num(r.volume,0);
    tr.appendChild(tdV);
    const tdN = document.createElement('td');
    tdN.className='mono';
    tdN.textContent = num(r.trades,0);
    tr.appendChild(tdN);
    const tdA = document.createElement('td');
    const star = document.createElement('button');
    star.className='emoji-btn'+(favs.has(r.symbol)?' active':'');
    star.textContent='‚≠ê';
    star.title='–ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
    star.onclick=(e)=>{ e.stopPropagation(); toggleFav(r.symbol); renderTop(); };
    const bell = document.createElement('button');
    bell.className='emoji-btn'+(alerts.has(r.symbol)?' active':'');
    bell.textContent='üîî';
    bell.title='–ê–ª–µ—Ä—Ç';
    bell.onclick=(e)=>{ e.stopPropagation(); toggleAlert(r.symbol); renderTop(); };
    tdA.appendChild(star);
    tdA.appendChild(bell);
    tr.appendChild(tdA);
    tbody.appendChild(tr);
  }
};
</script>
<style>
/* === FIX: Sharp and contrast icons for TOP (‚≠êüîî) === */
.emoji-btn {
  font-size: 18px !important;
  opacity: 0.95 !important;
  color: #ffd700 !important;
  filter: none !important;
  text-shadow: none !important;
  background: none !important;
  border: none !important;
  transition: transform 0.2s ease, opacity 0.2s ease;
}
.emoji-btn.active {
  opacity: 1 !important;
  transform: scale(1.2);
}
.emoji-btn[title="–ê–ª–µ—Ä—Ç"] {
  color: #ffcc00 !important;
}
.emoji-btn[title="–£–¥–∞–ª–∏—Ç—å"] {
  color: #ff4d4d !important;
  font-size: 19px !important;
}
</style>
<script>
// === PATCH: Add bell icon before trash in Favorites modal ===

function renderFavorites(){
  const favBox = document.querySelector('#modalContent #modalFavorites');
  if(!favBox) return;
  const favs = JSON.parse(localStorage.getItem('favs') || '[]');
  favBox.innerHTML = `<p class="heading n-green">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</p>`;
  if(!favs.length){
    favBox.innerHTML += '<p class="mini">–ü—É—Å—Ç–æ</p>';
    return;
  }

  // Table layout like in TOP modal
  const table = document.createElement('table');
  table.className = 'top-table';
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>–ú–æ–Ω–µ—Ç–∞</th>
      <th>–¶–µ–Ω–∞</th>
      <th>% 24—á</th>
      <th>–§–∞–Ω–¥–∏–Ω–≥</th>
      <th>–û–±—ä–µ–º ($)</th>
      <th>–°–¥–µ–ª–∫–∏ (24—á)</th>
      <th>üîî üóëÔ∏è</th>
    </tr>`;
  table.appendChild(thead);
  const tbody = document.createElement('tbody');

  const rows = getRows();
  const favSet = new Set(favs);
  const data = rows.filter(r => favSet.has(r.symbol));

  for(const r of data){
    const tr = document.createElement('tr');
    const tdSym = document.createElement('td');
    tdSym.className='top-symbol';
    tdSym.textContent = r.symbol;
    tdSym.onclick = ()=> onPickSymbol(r.symbol);
    tr.appendChild(tdSym);

    const tdP = document.createElement('td');
    tdP.className='mono';
    tdP.textContent = num(r.price, r.price<1?6:2);
    tr.appendChild(tdP);

    const tdPct = document.createElement('td');
    tdPct.textContent = pct(r.pct);
    tdPct.className = r.pct>=0?'top-value-green':'top-value-red';
    tr.appendChild(tdPct);

    const tdF = document.createElement('td');
    tdF.className='mono';
    tdF.textContent = fundFmt(r.funding);
    tr.appendChild(tdF);

    const tdV = document.createElement('td');
    tdV.className='mono';
    tdV.textContent = num(r.volume,0);
    tr.appendChild(tdV);

    const tdN = document.createElement('td');
    tdN.className='mono';
    tdN.textContent = num(r.trades,0);
    tr.appendChild(tdN);

    const tdActions = document.createElement('td');

    // Add bell (alert placeholder, no logic yet)
    const bell = document.createElement('button');
    bell.className='emoji-btn';
    bell.title='–ê–ª–µ—Ä—Ç';
    bell.textContent='üîî';
    bell.onclick=(e)=>{ e.stopPropagation(); /* reserved for future */ };
    tdActions.appendChild(bell);

    // Add trash
    const trash = document.createElement('button');
    trash.className='emoji-btn';
    trash.title='–£–¥–∞–ª–∏—Ç—å';
    trash.textContent='üóëÔ∏è';
    trash.onclick=(e)=>{ e.stopPropagation(); toggleFav(r.symbol); renderFavorites(); };
    tdActions.appendChild(trash);

    tr.appendChild(tdActions);
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  favBox.appendChild(table);
}
</script>
<script>
// === Anomalies Pro (24h) ===
(function(){
  let anomMode = 'all';
  let anomTimer = null;
  const REFRESH_MS = 60000;

  function robustStats(values){
    const arr = values.filter(v => Number.isFinite(v)).slice().sort((a,b)=>a-b);
    if(!arr.length) return {median:NaN, mad:NaN};
    const mid = Math.floor(arr.length/2);
    const median = arr.length%2 ? arr[mid] : (arr[mid-1]+arr[mid])/2;
    const dev = arr.map(v => Math.abs(v - median)).sort((a,b)=>a-b);
    const mad = dev.length%2 ? dev[mid] : (dev[mid-1]+dev[mid])/2;
    return {median, mad: mad || 1e-9};
  }
  function robustZ(val, median, mad){
    if(!Number.isFinite(val)) return 0;
    return 0.6745 * (val - median) / mad;
  }

  function enrichRows(rows){
    // add basis from mark price if available
    return rows.map(r=>{
      const mk = fundingMap.get(r.symbol);
      const mark = mk ? Number(mk.p || mk.P || NaN) : NaN;
      const basis = (Number.isFinite(mark) && Number.isFinite(r.price) && r.price>0) ? (mark - r.price)/r.price*100 : NaN;
      return { ...r, basis };
    });
  }

  function scoreAnomalies(mode){
    const raw = enrichRows(getRows()); // [{symbol, price, pct, funding, volume, trades, basis}]
    // collect arrays
    const pctArr = raw.map(r=>r.pct);
    const volArr = raw.map(r=>Math.log10(Math.max(r.volume,1)));
    const trdArr = raw.map(r=>Math.log10(Math.max(r.trades,1)));
    const fundArr = raw.map(r=>r.funding*100); // %
    const basArr = raw.map(r=>r.basis);

    const sp = {
      pct: robustStats(pctArr),
      vol: robustStats(volArr),
      trd: robustStats(trdArr),
      fund: robustStats(fundArr),
      bas: robustStats(basArr)
    };

    const out = [];
    for(const r of raw){
      const zPct  = robustZ(r.pct, sp.pct.median, sp.pct.mad);
      const zVol  = robustZ(Math.log10(Math.max(r.volume,1)), sp.vol.median, sp.vol.mad);
      const zTrd  = robustZ(Math.log10(Math.max(r.trades,1)), sp.trd.median, sp.trd.mad);
      const zFund = robustZ(r.funding*100, sp.fund.median, sp.fund.mad);
      const zBas  = robustZ(r.basis, sp.bas.median, sp.bas.mad);

      // Weighted anomaly score - MODIFIED: Increased weights for stronger filtering
      let score = 0;
      if(mode==='all'){
        score = Math.hypot(zPct*1.0, zVol*0.8, zTrd*0.6, zFund*0.9, zBas*0.8);
      }else if(mode==='scalp'){
        // Scalping: high volume, high trades, tight spreads (low basis), moderate volatility
        score = Math.abs(zVol)*1.5 + Math.abs(zTrd)*1.3 + Math.abs(zPct)*0.6;
        // Bonus for high liquidity coins
        if(r.volume > 50000000 && r.trades > 100000) score *= 1.2;
      }else if(mode==='intraday'){
        // Intraday: good volatility, decent volume, price movement
        score = Math.abs(zPct)*1.4 + Math.abs(zVol)*1.0 + Math.abs(zTrd)*0.7;
        // Bonus for moderate volatility (not too extreme)
        if(Math.abs(r.pct) > 2 && Math.abs(r.pct) < 15) score *= 1.3;
      }else if(mode==='funding'){
        score = Math.abs(zFund)*1.4 + Math.abs(zBas)*0.4;
      }else if(mode==='basis'){
        score = Math.abs(zBas)*1.4 + Math.abs(zFund)*0.4;
      }else if(mode==='volume'){
        score = Math.abs(zVol)*1.3 + Math.abs(zTrd)*0.9;
      }else if(mode==='price'){
        score = Math.abs(zPct)*1.3 + Math.abs(zVol)*0.5;
      }
      out.push({ ...r, score, z: {zPct, zVol, zTrd, zFund, zBas} });
    }

    // filter: keep strong anomalies - MODIFIED: Different thresholds per mode
    let threshold = 4.5; // default for 'all'
    if(mode === 'scalp' || mode === 'intraday') threshold = 2.0; // lower threshold for trading modes
    
    const filtered = out
      .filter(x => Number.isFinite(x.score))
      .filter(x => x.score > threshold)
      .sort((a,b)=> b.score - a.score)
      .slice(0, 120);

    return filtered;
  }

  function renderAnomalies(){
    const tbody = document.querySelector('#modalContent #setupsTableBodyAlt');
    if(!tbody) return;
    const favs = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
    const alerts = new Set(JSON.parse(localStorage.getItem('alerts')||'[]'));
    const rows = scoreAnomalies(anomMode);

    tbody.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');

      const tdSym = document.createElement('td');
      tdSym.className='top-symbol';
      tdSym.textContent = r.symbol;
      tdSym.onclick = ()=> onPickSymbol(r.symbol);
      tr.appendChild(tdSym);

      const tdP = document.createElement('td');
      tdP.className='mono';
      tdP.textContent = num(r.price, r.price<1?6:2);
      tr.appendChild(tdP);

      const tdPct = document.createElement('td');
      tdPct.textContent = pct(r.pct);
      tdPct.className = r.pct>=0?'top-value-green':'top-value-red';
      tr.appendChild(tdPct);

      const tdF = document.createElement('td');
      tdF.className='mono';
      tdF.textContent = (r.funding>=0?'+':'') + (r.funding*100).toFixed(4) + '%';
      tr.appendChild(tdF);

      const tdB = document.createElement('td');
      tdB.className='mono';
      tdB.textContent = Number.isFinite(r.basis) ? (r.basis>=0?'+':'') + r.basis.toFixed(3) + '%' : '‚Äî';
      tr.appendChild(tdB);

      const tdV = document.createElement('td');
      tdV.className='mono';
      tdV.textContent = num(r.volume,0);
      tr.appendChild(tdV);

      const tdN = document.createElement('td');
      tdN.className='mono';
      tdN.textContent = num(r.trades,0);
      tr.appendChild(tdN);

      const tdA = document.createElement('td');
      const star = document.createElement('button');
      star.className='emoji-btn'+(favs.has(r.symbol)?' active':'');
      star.textContent='‚≠ê';
      star.title='–ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
      star.onclick=(e)=>{ e.stopPropagation(); toggleFav(r.symbol); renderAnomalies(); };
      const bell = document.createElement('button');
      bell.className='emoji-btn'+(alerts.has(r.symbol)?' active':'');
      bell.textContent='üîî';
      bell.title='–ê–ª–µ—Ä—Ç';
      bell.onclick=(e)=>{ e.stopPropagation(); toggleAlert(r.symbol); renderAnomalies(); };
      tdA.appendChild(star);
      tdA.appendChild(bell);
      tr.appendChild(tdA);

      tbody.appendChild(tr);
    }
    const upd = document.querySelector('#modalContent #setupsUpdatedAlt');
    if(upd) upd.textContent = new Date().toLocaleTimeString();
  }

  function startAnomalies(){
    if(anomTimer) clearInterval(anomTimer);
    renderAnomalies();
    anomTimer = setInterval(renderAnomalies, REFRESH_MS);
  }

  function anomInitUI(){
    const seg = document.querySelector('#modalContent #setupsSegAlt');
    if(!seg) return;
    seg.querySelectorAll('button').forEach(btn=>{
      btn.onclick = ()=>{
        seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        anomMode = btn.dataset.mode;
        renderAnomalies();
      };
    });
  }

  // Bind to Anomalies button
  try{
    if(window.btnSetupsAlt){
      btnSetupsAlt.replaceWith(btnSetupsAlt.cloneNode(true));
      const freshBtn = document.getElementById('btnSetupsAlt');
      freshBtn.addEventListener('click', () => {
        openModal('üì° –°–µ—Ç–∞–ø—ã', 'modalSetupsAltPro');
        anomInitUI();
        startAnomalies();
      });
    }
  }catch(e){ /* no-op */ }

  document.addEventListener('DOMContentLoaded', ()=>{
    const b = document.getElementById('btnSetupsAlt');
    if(b){
      b.addEventListener('click', () => {
        openModal('üì° –°–µ—Ç–∞–ø—ã', 'modalSetupsAltPro');
        anomInitUI();
        startAnomalies();
      });
    }
  });
})();
</script>
<style>
/* Listings badges & clean cells */
.list-date {
  font-weight: 800;
}
.badge-chip {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 10px;
  margin-left: 6px;
  border: 1px solid var(--border);
  background: var(--button-bg);
  color: var(--text);
}
.badge-today { color: var(--text); border-color: var(--green); }
.badge-soon { color: var(--text); border-color: var(--blue); }
.badge-past { color: var(--text); border-color: var(--red); }
.list-exchange { font-weight: 700; }
.list-token { font-weight: 800; letter-spacing: 0.2px; }
.list-type { font-weight: 700; color: var(--muted); }
</style>
<script>
// === Listings Pro: recent (<=14d past) & upcoming ===
(function(){
  let listingsMode = 'upcoming';
  let listingsTimer = null;
  const REFRESH_MS = 60000_000; // doesn't need to be too frequent
  const DAY_MS = 86400000;

  // Source of truth: can be replaced at runtime via updateListings([...])
  // Fields: {date: '2025-11-05T12:00:00Z', exchange:'Binance', token:'ABC', pair:'ABC/USDT', type:'Spot|Futures|IEO', note:''}
  let LISTINGS_FEED = (function(){
    try{
      const saved = localStorage.getItem('listingsFeed');
      if(saved) return JSON.parse(saved);
    }catch(e){}
    // default empty feed ‚Äî ready for live data injection
    return [];
  })();

  // Public helper to update listings from external code (optional)
  window.updateListings = function(arr){
    if(!Array.isArray(arr)) return;
    LISTINGS_FEED = arr.map(x=> ({
      date: x.date,
      exchange: x.exchange || '',
      token: x.token || x.symbol || '',
      pair: x.pair || '',
      type: x.type || '',
      note: x.note || ''
    }));
    try{ localStorage.setItem('listingsFeed', JSON.stringify(LISTINGS_FEED)); }catch(e){}
    renderListings();
  };

  function fmtDate(d){
    try{
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const dd = String(dt.getDate()).padStart(2,'0');
      const hh = String(dt.getHours()).padStart(2,'0');
      const mm = String(dt.getMinutes()).padStart(2,'0');
      return `${dd}.${m}.${y} ${hh}:${mm}`;
    }catch(e){ return String(d||'‚Äî'); }
  }
  function relBadge(d){
    const now = Date.now();
    const ts = +new Date(d);
    const diff = ts - now;
    const absd = Math.round(Math.abs(diff) / DAY_MS);
    if(Math.abs(diff) < DAY_MS/2){
      return `<span class="badge-chip badge-today">—Å–µ–≥–æ–¥–Ω—è</span>`;
    }
    if(diff > 0){
      return `<span class="badge-chip badge-soon">—á–µ—Ä–µ–∑ ${absd}–¥</span>`;
    }else{
      return `<span class="badge-chip badge-past">${absd}–¥ –Ω–∞–∑–∞–¥</span>`;
    }
  }

  function pickUpcoming(){
    const now = Date.now();
    return LISTINGS_FEED
      .filter(x => +new Date(x.date) >= now - DAY_MS/2) // today and forward
      .sort((a,b)=> +new Date(a.date) - +new Date(b.date));
  }
  function pickRecent(){
    const now = Date.now();
    const cutoff = now - 14*DAY_MS;
    return LISTINGS_FEED
      .filter(x => {
        const ts = +new Date(x.date);
        return ts < now && ts >= cutoff;
      })
      .sort((a,b)=> +new Date(b.date) - +new Date(a.date));
  }

  function renderListings(){
    const tbody = document.querySelector('#modalContent #listingsTableBody');
    if(!tbody) return;
    const rows = (listingsMode==='upcoming') ? pickUpcoming() : pickRecent();

    tbody.innerHTML = '';
    if(!rows.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.innerHTML = '<span class="mini">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å JSON —á–µ—Ä–µ–∑ window.updateListings([...]).</span>';
      tr.appendChild(td);
      tbody.appendChild(tr);
    }else{
      for(const r of rows){
        const tr = document.createElement('tr');

        const tdD = document.createElement('td');
        tdD.innerHTML = `<span class="list-date">${fmtDate(r.date)}</span> ${relBadge(r.date)}`;
        tr.appendChild(tdD);

        const tdEx = document.createElement('td');
        tdEx.innerHTML = `<span class="list-exchange">${r.exchange || '‚Äî'}</span>`;
        tr.appendChild(tdEx);

        const tdTok = document.createElement('td');
        tdTok.innerHTML = `<span class="list-token">${r.token || '‚Äî'}</span>`;
        tr.appendChild(tdTok);

        const tdPair = document.createElement('td');
        tdPair.textContent = r.pair || '‚Äî';
        tr.appendChild(tdPair);

        const tdType = document.createElement('td');
        tdType.innerHTML = `<span class="list-type">${r.type || '‚Äî'}</span>`;
        tr.appendChild(tdType);

        const tdNote = document.createElement('td');
        tdNote.className='mini';
        tdNote.textContent = (r.note || '').slice(0,80);
        tr.appendChild(tdNote);

        tbody.appendChild(tr);
      }
    }

    const upd = document.querySelector('#modalContent #listingsUpdated');
    if(upd) upd.textContent = new Date().toLocaleTimeString();
  }

  function startListings(){
    if(listingsTimer) clearInterval(listingsTimer);
    renderListings();
    listingsTimer = setInterval(renderListings, REFRESH_MS);
  }

  function initListingsUI(){
    const seg = document.querySelector('#modalContent #listingsSeg');
    if(!seg) return;
    seg.querySelectorAll('button').forEach(btn=>{
      btn.onclick = ()=>{
        seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        listingsMode = btn.dataset.mode;
        renderListings();
      };
    });
  }

  // Bind to Listings button
  try{
    if(window.btnListings){
      btnListings.replaceWith(btnListings.cloneNode(true));
      const freshBtn = document.getElementById('btnListings');
      freshBtn.addEventListener('click', () => {
        openModal('üöÄ –õ–∏—Å—Ç–∏–Ω–≥–∏', 'modalListingsPro');
        initListingsUI();
        startListings();
      });
    }
  }catch(e){ /* no-op */ }

  document.addEventListener('DOMContentLoaded', ()=>{
    const b = document.getElementById('btnListings');
    if(b){
      b.addEventListener('click', () => {
        openModal('üöÄ –õ–∏—Å—Ç–∏–Ω–≥–∏', 'modalListingsPro');
        initListingsUI();
        startListings();
      });
    }
  });
})();
</script>
<script>
// === Listings: auto-fetch from Vercel endpoint ===
(function(){
  const FEED_URL = (window.LISTINGS_FEED_URL || 'https://YOUR-VERCEL-APP.vercel.app/api/listings');
  const REFRESH_MS_REMOTE = 15 * 60 * 1000; // 15 minutes

  async function fetchListingsRemote(){
    try{
      const r = await fetch(FEED_URL, {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      if(Array.isArray(data)) window.updateListings(data);
    }catch(e){
      console.warn('Listings remote fetch failed:', e.message);
    }
  }

  // kick + periodic refresh
  document.addEventListener('DOMContentLoaded', ()=>{
    fetchListingsRemote();
    setInterval(fetchListingsRemote, REFRESH_MS_REMOTE);
  });
})();
</script>
<script>
// === Listings: auto-fetch from Vercel (Quantum Trader) ===
(function(){
  const FEED_URL = 'https://quantum-trader-orpin.vercel.app/api/listings';
  const REFRESH_MS_REMOTE = 15 * 60 * 1000; // 15 minutes

  async function fetchListingsRemote(){
    const stamp = document.querySelector('#listingsUpdated');
    try{
      const r = await fetch(FEED_URL, {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      if(Array.isArray(data)) window.updateListings(data);
      if(stamp) stamp.textContent = new Date().toLocaleTimeString();
    }catch(e){
      console.warn('Listings fetch failed:', e.message);
      if(stamp) stamp.textContent = '–æ—à–∏–±–∫–∞';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    fetchListingsRemote();
    setInterval(fetchListingsRemote, REFRESH_MS_REMOTE);
  });
})();
</script>
<script>
// === Auto suffix for ticker search ===
(function(){
  function normalizeTicker(ticker){
    if(!ticker) return '';
    let val = ticker.trim().toUpperCase();
    if(!/(USDT|USDC|PERP|USD|BTC)$/.test(val)){
      val += 'USDT';
    }
    return val;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const input = document.querySelector('#searchInput') || document.querySelector('.search-input');
    if(input){
      input.addEventListener('change', e=>{
        const normalized = normalizeTicker(e.target.value);
        e.target.value = normalized;
        if(typeof onPickSymbol === 'function'){
          onPickSymbol(normalized);
        }
      });
      input.addEventListener('keypress', e=>{
        if(e.key==='Enter'){
          e.preventDefault();
          const normalized = normalizeTicker(e.target.value);
          e.target.value = normalized;
          if(typeof onPickSymbol === 'function'){
            onPickSymbol(normalized);
          }
        }
      });
    }
  });
})();
</script>
<script>
// ‚≠ê –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –ø–æ–∏—Å–∫–∞
document.getElementById('btnFavFromSearch').addEventListener('click', () => {
  const sym = document.getElementById('sym').value.trim().toUpperCase();
  if (!sym) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–∏–º–≤–æ–ª –º–æ–Ω–µ—Ç—ã');
  const favs = new Set(JSON.parse(localStorage.getItem('favs') || '[]'));
  if (favs.has(sym)) {
    favs.delete(sym);
    alert(`‚ùå ${sym} —É–¥–∞–ª—ë–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ`);
  } else {
    favs.add(sym);
    alert(`‚≠ê ${sym} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ`);
  }
  localStorage.setItem('favs', JSON.stringify([...favs]));
});
</script><script>
// üîî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç—ã –≤ –∞–ª–µ—Ä—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏ –ø–æ–∏—Å–∫–∞
document.getElementById('btnAlertFromSearch').addEventListener('click', () => {
  const sym = document.getElementById('sym').value.trim().toUpperCase();
  if (!sym) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–∏–º–≤–æ–ª –º–æ–Ω–µ—Ç—ã');
  const alerts = new Set(JSON.parse(localStorage.getItem('alerts') || '[]'));
  if (alerts.has(sym)) {
    alerts.delete(sym);
    alert(`üîï ${sym} —É–¥–∞–ª—ë–Ω –∏–∑ –∞–ª–µ—Ä—Ç–æ–≤`);
  } else {
    alerts.add(sym);
    alert(`üîî ${sym} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–ª–µ—Ä—Ç—ã`);
  }
  localStorage.setItem('alerts', JSON.stringify([...alerts]));
});
</script><script>
// === CEX vs DEX Spreads via CoinGecko (proxied) ===
(function(){
  const CG = 'https://api.coingecko.com/api/v3';
  const PROXY = 'https://api.allorigins.win/raw?url=';

  // DEX shortlist (incl. Solana) - can extend later
  const DEXES = [
    'uniswap_v3',          // Ethereum
    'pancakeswap_v3',      // BNB Chain
    'orca',                // Solana
    'raydium',             // Solana
    'jupiter',             // Solana aggregator
    'hyperliquid',         // Hyperliquid (may not exist on CG; ignored if not)
    'curve',               // Curve Finance
    'sushiswap',
    'dodo',
    'quickswap',
    'balancer',
    '1inch_liquidity_protocol',
    'dexscreener',         // DEX Screener (not a CG exchange, may fail)
    'gmgn'                 // GMGN (tool) - may not be available on CG
  ];

  let _dexCache = null;       // Map BASE -> average USDT price
  let _timer = null;

  async function proxiedJson(url){
    const r = await fetch(PROXY + encodeURIComponent(url));
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }

  async function fetchTickers(exId){
    const url = `${CG}/exchanges/${exId}/tickers?include_exchange_logo=false`;
    const j = await proxiedJson(url);
    return j.tickers || [];
  }

  async function buildDexUsdtMap(force=false){
    if(!force && _dexCache && (Date.now() - _dexCache._t < 55_000)) return _dexCache;
    const map = new Map();
    for(const dex of DEXES){
      try{
        const tks = await fetchTickers(dex);
        for(const t of tks){
          if(t.is_stale || t.is_anomaly) continue;
          if(!t.target || t.target.toUpperCase()!=='USDT') continue;
          const base = (t.base||'').toUpperCase();
          const price = Number(t.last || (t.converted_last && t.converted_last.usd) || NaN);
          if(!isFinite(price) || price<=0) continue;
          const prev = map.get(base);
          map.set(base, prev ? (prev + price)/2 : price); // smooth average to tame outliers
        }
      }catch(e){ /* ignore dex failure */ }
    }
    map._t = Date.now();
    _dexCache = map;
    return map;
  }

  function num(v, d=2){ if(!isFinite(v)) return '‚Äî'; return Number(v).toLocaleString(undefined,{maximumFractionDigits:d}); }
  function badge(p){ return p>=10?'üü•':(p>=5?'üüß':'üü®'); }

  async function renderSpreadsFor(exId){
    const tbody = document.querySelector('#modalContent #spreadsBody');
    if(!tbody) return;
    tbody.innerHTML = '<tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
    try{
      const [dexMap, cexTicks] = await Promise.all([buildDexUsdtMap(), fetchTickers(exId)]);
      const rows = [];
      for(const t of cexTicks){
        if(t.is_stale || t.is_anomaly) continue;
        if(!t.target || t.target.toUpperCase()!=='USDT') continue;
        const base = (t.base||'').toUpperCase();
        const cexPrice = Number(t.last || (t.converted_last && t.converted_last.usd) || NaN);
        const dexPrice = dexMap.get(base);
        if(!isFinite(cexPrice) || cexPrice<=0) continue;
        if(!isFinite(dexPrice) || dexPrice<=0) continue;
        const sp = Math.abs(cexPrice - dexPrice) / dexPrice * 100;
        if(sp >= 1.5){ rows.push({ base, cexPrice, dexPrice, sp }); }
      }
      rows.sort((a,b)=> b.sp - a.sp);
      tbody.innerHTML='';
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="4">–ù–µ—Ç —Å–ø—Ä–µ–¥–æ–≤ ‚â• 2% –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–∏—Ä–∂–∏</td></tr>';
      }else{
        for(const r of rows.slice(0,200)){
          const tr = document.createElement('tr');
          const tdM = document.createElement('td'); tdM.className='top-symbol'; tdM.textContent = r.base; tr.appendChild(tdM);
          const tdC = document.createElement('td'); tdC.className='mono'; tdC.textContent = num(r.cexPrice, r.cexPrice<1?6:4); tr.appendChild(tdC);
          const tdD = document.createElement('td'); tdD.className='mono'; tdD.textContent = num(r.dexPrice, r.dexPrice<1?6:4); tr.appendChild(tdD);
          const tdS = document.createElement('td'); const p=r.sp.toFixed(2)+'%'; tdS.innerHTML = `${badge(r.sp)} <b>${p}</b>`;
          if(r.sp>=10){ tdS.className='top-value-red'; }
          else if(r.sp>=5){ tdS.style.color = '#ffb84d'; }
          else { tdS.style.color = '#ffd24d'; }
          tr.appendChild(tdS);
          tr.onclick = ()=>{
            const sym = r.base + 'USDT';
            window.dispatchEvent(new CustomEvent('symbol-picked', {detail:{symbol:sym}}));
          };
          tbody.appendChild(tr);
        }
      }
      const upd = document.querySelector('#modalContent #spreadsUpdated');
      if(upd) upd.textContent = new Date().toLocaleTimeString();
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (${e && e.message ? e.message : e})</td></tr>`;
    }
  }

  function hookUI(){
    const seg = document.querySelector('#modalContent #spreadsSeg');
    if(!seg) return;
    seg.querySelectorAll('button').forEach(b=>{
      b.onclick = ()=>{
        seg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        if(_timer) clearInterval(_timer);
        renderSpreadsFor(b.dataset.ex);
        _timer = setInterval(()=> renderSpreadsFor(b.dataset.ex), 60_000);
      };
    });
    // start with active (MEXC by default)
    const first = seg.querySelector('button.active') || seg.querySelector('button');
    if(first){
      if(_timer) clearInterval(_timer);
      renderSpreadsFor(first.dataset.ex);
      _timer = setInterval(()=> renderSpreadsFor(first.dataset.ex), 60_000);
    }
  }

  // Settings button handler removed - using default handler at line 459
})();
</script>
<script>
// --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–∫–∞ –ø–æ –∑–≤–µ–∑–¥–µ —É —Å—Ç—Ä–æ–∫–∏ –ø–æ–∏—Å–∫–∞ ---
const btnFavFromSearch = document.getElementById('btnFavFromSearch');
if (btnFavFromSearch && symInput) {
  btnFavFromSearch.addEventListener('click', (e) => {
    e.preventDefault();
    const val = symInput.value.trim().toUpperCase();
    if (!val) return;

    // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–∏–º–≤–æ–ª
    let sym = val.replace(/^BINANCE:/, '');
    if (sym.endsWith('USDTPERP')) sym = sym.replace('USDTPERP', 'USDT');
    if (!/USDT$/.test(sym)) sym += 'USDT';

    // –¥–æ–±–∞–≤–ª—è–µ–º/—É–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    const favs = new Set(JSON.parse(localStorage.getItem('favs') || '[]'));
    if (favs.has(sym)) {
      favs.delete(sym);
      Telegram.WebApp?.HapticFeedback?.impactOccurred('light');
    } else {
      favs.add(sym);
      Telegram.WebApp?.HapticFeedback?.notificationOccurred('success');
    }
    localStorage.setItem('favs', JSON.stringify([...favs]));

    // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ
    btnFavFromSearch.classList.toggle('active', favs.has(sym));

    // –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
    if (document.querySelector('#modalContent #modalFavorites')) {
      renderFavorites();
    }
  });
}
</script>
<style>
/* –ß–∏—Ç–∞–±–µ–ª—å–Ω–∞—è –Ω–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞) */
#setupsTableBody tr td { padding: 8px 5px; font-size: 12px; }
@media (max-width:600px){
  #setupsTableBody tr td { padding: 6px 3px; font-size: 11px; line-height: 1.3; }
  /* –ü–æ–¥ —Ç–∏–∫–µ—Ä–æ–º –¥–∞—ë–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–æ –∫ –∫—Ä–∞—é */
  .wrap { padding-bottom: 80px; }
}
</style>
<script>
// === –ù–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –∞–∫—Ç–∏–≤–Ω–∞—è –º–æ–Ω–µ—Ç–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ===
(function(){
  const tbodyId = 'setupsTableBody';
  let timer = null;

  function normalize(sym){
    let s = String(sym || '').toUpperCase().replace(/^BINANCE:/,'').replace(/[^A-Z0-9]/g,'');
    if (s.endsWith('USDTPERP')) s = s.replace('USDTPERP','USDT');
    if (!/USDT$/.test(s)) s += 'USDT';
    return s;
  }

  async function get24h(sym){
    const r = await fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${sym}`);
    if(!r.ok) throw new Error('24hr '+r.status);
    return r.json();
  }
  async function getFunding(sym){
    // premiumIndex –æ—Ç–¥–∞—ë—Ç lastFundingRate
    const r = await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${sym}`);
    if(!r.ok) throw new Error('premiumIndex '+r.status);
    return r.json();
  }

  function num(v,d=2){ if(!isFinite(v)) return '‚Äî'; return Number(v).toLocaleString(undefined,{maximumFractionDigits:d}); }
  function pct(v){ if(!isFinite(v)) return '‚Äî'; const s = (v>=0?'+':'') + Number(v).toFixed(2) + '%'; return s; }
  function fundFmt(v){ if(!isFinite(v)) return '‚Äî'; const s=(v>=0?'+':'') + (v*100).toFixed(4) + '%'; return s; }

  async function render(sym){
    const tbody = document.getElementById(tbodyId);
    if(!tbody) return;
    sym = normalize(sym);
    tbody.innerHTML = `<tr><td colspan="7"></td></tr>`;
    try{
      const [t24, prem] = await Promise.all([get24h(sym), getFunding(sym)]);
      const price = Number(t24.lastPrice);
      const priceStr = price.toLocaleString(undefined,{maximumFractionDigits: price<1?6:2});
      const pctVal = Number(t24.priceChangePercent);
      const vol = Number(t24.quoteVolume);
      const trades = Number(t24.count);
      const funding = Number(prem.lastFundingRate || 0);

      // —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ –∞–ª–µ—Ä—Ç–æ–≤
      const favs = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
      const alerts = new Set(JSON.parse(localStorage.getItem('alerts')||'[]'));
      const isFav = favs.has(sym);
      const hasAlert = alerts.has(sym);

      const tr = document.createElement('tr');

      const tdSym = document.createElement('td'); tdSym.className='top-symbol mono'; tdSym.textContent = sym; tdSym.onclick = ()=>onPickSymbol(sym); tdSym.style.fontWeight = '700';
      const tdP   = document.createElement('td'); tdP.className='mono'; tdP.textContent = priceStr;
      const tdPct = document.createElement('td'); tdPct.textContent = pct(pctVal); tdPct.className = pctVal>=0?'top-value-green':'top-value-red';
      const tdF   = document.createElement('td'); tdF.className='mono'; tdF.textContent = fundFmt(funding);
      const tdV   = document.createElement('td'); tdV.className='mono'; tdV.textContent = num(vol,0);
      const tdN   = document.createElement('td'); tdN.className='mono'; tdN.textContent = num(trades,0);

      const tdA   = document.createElement('td');
      const star  = document.createElement('button'); star.className='emoji-btn'+(isFav?' active':''); star.textContent='‚≠ê'; star.title='–ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
      star.onclick = (e)=>{ e.stopPropagation(); toggleFav(sym); render(sym); };
      const bell  = document.createElement('button'); bell.className='emoji-btn'+(hasAlert?' active':''); bell.textContent='üîî'; bell.title='–ê–ª–µ—Ä—Ç';
      bell.onclick = (e)=>{ e.stopPropagation(); toggleAlert(sym); render(sym); };
      tdA.appendChild(star); tdA.appendChild(bell);

      tr.appendChild(tdSym); tr.appendChild(tdP); tr.appendChild(tdPct); tr.appendChild(tdF); tr.appendChild(tdV); tr.appendChild(tdN); tr.appendChild(tdA);
      tbody.innerHTML = '';
      tbody.appendChild(tr);
    }catch(err){
      console.error('bottom row render err', err);
      tbody.innerHTML = `<tr><td colspan="7">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    }
  }

  function kick(sym){
    clearInterval(timer);
    render(sym);
    timer = setInterval(()=>render(sym), 60_000);
  }

  // –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–æ–Ω–µ—Ç—ã
  window.addEventListener('symbol-picked', (ev)=>{
    const s = ev?.detail?.symbol;
    if(s) kick(s);
  });

  // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.addEventListener('DOMContentLoaded', ()=>{
    const s = document.getElementById('oiSym')?.textContent?.trim();
    if(s) kick(s);
  });
})();
</script>
<style>
/* --- –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –Ω–∏–∂–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ --- */
@media (max-width:700px){
  #setupsTableBody tr td {
    font-size: 11px !important;
    padding: 6px 3px !important;
    color: var(--muted) !important;
    border-top: 1px solid rgba(255,255,255,0.06);
  }
  #setupsTableBody tr {
    background: rgba(255,255,255,0.02);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  #setupsTableBody tr td.top-value-green {
    color: #40e080 !important;
  }
  #setupsTableBody tr td.top-value-red {
    color: #ff6070 !important;
  }
  /* –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä—è–¥ ‚Äî –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª */
  .wrap {
    padding-bottom: 85px !important;
  }
}
</style>
<!-- Embedded CoinGecko scanner removed - using external spreads_autoscanner_patch_v3_1.js -->
<script src="/spreads_autoscanner_patch_v3_1.js"></script>
</body>
</html>